Архитектура базы данных криптовалютной арбитражной системы

## 1. Основные сущности

### Таблица: users (Пользователи)
**Назначение**: Хранение учетных данных, профилей и настроек пользователей системы.  
**Описание полей**:
- **user_id** (BIGSERIAL) — Уникальный идентификатор пользователя. PRIMARY KEY. Значение генерируется автоматически.
- **email** (VARCHAR(255)) — Электронная почта пользователя, используется как логин. Уникальное значение.
- **password_hash** (TEXT) — Хэшированный пароль для безопасной аутентификации.
- **full_name** (VARCHAR(100)) — Полное имя пользователя.
- **role** (VARCHAR(20)) — Роль пользователя в системе. Допустимые значения: 'trader', 'admin'. По умолчанию 'trader'.
- **timezone** (VARCHAR(50)) — Часовой пояс пользователя. По умолчанию 'UTC'.
- **preferred_currency** (VARCHAR(10)) — Предпочитаемая валюта для отображения. Допустимые значения: 'USDT', 'USD'. По умолчанию 'USDT'.
- **settings** (JSONB) — Хранение персональных настроек: пороги доходности, пресеты фильтров.
- **is_email_verified** (BOOLEAN) — Флаг подтверждения электронной почты.
- **status** (VARCHAR(20)) — Статус учетной записи. Допустимые значения: 'active', 'blocked'. По умолчанию 'active'.
- **created_at, updated_at** (TIMESTAMPTZ) — Временные метки создания и последнего обновления записи. created_at по умолчанию устанавливается в now().

**Ограничения (Constraints)**:
- **users_pkey** (PRIMARY KEY): Первичный ключ на поле user_id.
- **users_email_key** (UNIQUE CONSTRAINT): Гарантирует уникальность email.
- **role_check**: Проверка допустимых значений для поля role.
- **status_check**: Проверка допустимых значений для поля status.
- **preferred_currency_check**: Проверка допустимых значений для поля preferred_currency.
- **NOT NULL**: Обязательные поля: email, password_hash, role, timezone, preferred_currency, is_email_verified, status, created_at, updated_at.

**Индексы (Indexes)**:
- **users_email_key** (UNIQUE INDEX): Обеспечивает уникальность email и ускоряет поиск пользователя по почте.

---

### Таблица: user_api_keys (API-ключи пользователей)
**Назначение**: Хранение зашифрованных API-ключей для подключения к криптобиржам.  
**Описание полей**:
- **key_id** (UUID) — Уникальный идентификатор ключа. PRIMARY KEY. Значение генерируется автоматически.
- **user_id** (BIGINT) — Идентификатор владельца ключа. FOREIGN KEY на users(user_id).
- **exchange_name** (VARCHAR(50)) — Название биржи, для которой предназначен ключ. По умолчанию 'BingX'.
- **key_name** (VARCHAR(100)) — Произвольное название ключа для удобства пользователя.
- **api_key_encrypted** (TEXT) — Зашифрованное значение API-ключа.
- **api_secret_encrypted** (TEXT) — Зашифрованное значение секретного ключа.
- **permissions** (JSONB) — Права доступа ключа. По умолчанию '["read"]'.
- **is_active** (BOOLEAN) — Флаг активности ключа.
- **created_at** (TIMESTAMPTZ) — Время создания ключа.

**Ограничения (Constraints)**:
- **user_api_keys_pkey** (PRIMARY KEY): Первичный ключ на поле key_id.
- **user_api_keys_user_id_fkey** (FOREIGN KEY): Внешний ключ, связывающий user_id с таблицей users. ON DELETE CASCADE.
- **NOT NULL**: Обязательные поля: user_id, api_key_encrypted, api_secret_encrypted, permissions, is_active, created_at.

**Индексы (Indexes)**:
- **idx_api_keys_user** (INDEX): Ускоряет поиск всех ключей конкретного пользователя.

---

### Таблица: exchanges (Биржи)
**Назначение**: Справочник криптовалютных бирж, интегрированных в систему.  
**Описание полей**:
- **exchange_id** (SERIAL) — Уникальный идентификатор биржи. PRIMARY KEY.
- **name** (VARCHAR(50)) — Название биржи.
- **status** (VARCHAR(20)) — Текущий статус биржи. По умолчанию 'online'.
- **base_url** (TEXT) — Базовый URL API биржи.

**Ограничения (Constraints)**:
- **exchanges_pkey** (PRIMARY KEY): Первичный ключ на поле exchange_id.
- **exchanges_name_key** (UNIQUE CONSTRAINT): Гарантирует уникальность названий бирж.
- **NOT NULL**: Обязательные поля: name, base_url.

**Индексы (Indexes)**:
- **exchanges_name_key** (UNIQUE INDEX): Ускоряет поиск биржи по названию.

---

### Таблица: trading_pairs (Торговые пары)
**Назначение**: Хранение информации о доступных торговых парах на биржах.  
**Описание полей**:
- **pair_id** (SERIAL) — Уникальный идентификатор торговой пары. PRIMARY KEY.
- **exchange_id** (INT) — Идентификатор биржи. FOREIGN KEY на exchanges(exchange_id).
- **symbol** (VARCHAR(30)) — Символ торговой пары (например, BTC-USDT).
- **base_asset** (VARCHAR(10)) — Базовый актив (например, BTC).
- **quote_asset** (VARCHAR(10)) — Котируемый актив (например, USDT).
- **min_notional** (NUMERIC(20, 8)) — Минимальная сумма для торговли в котируемой валюте.
- **max_leverage** (INT) — Максимальное плечо для фьючерсной торговли. По умолчанию 50.
- **is_active** (BOOLEAN) — Флаг активности торговой пары.
- **created_at** (TIMESTAMPTZ) — Время создания записи.

**Ограничения (Constraints)**:
- **trading_pairs_pkey** (PRIMARY KEY): Первичный ключ на поле pair_id.
- **trading_pairs_exchange_id_fkey** (FOREIGN KEY): Внешний ключ, связывающий exchange_id с таблицей exchanges.
- **trading_pairs_exchange_id_symbol_key** (UNIQUE CONSTRAINT): Гарантирует уникальность пары (биржа, символ).
- **NOT NULL**: Обязательные поля: exchange_id, symbol, base_asset, quote_asset, is_active, created_at.

**Индексы (Indexes)**:
- **trading_pairs_exchange_id_symbol_key** (UNIQUE INDEX): Ускоряет поиск торговой пары по бирже и символу.

---

### Таблица: funding_rate_history (История фандинговых ставок)
**Назначение**: Хранение исторических данных о фандинговых ставках для расчета доходности.  
**Описание полей**:
- **pair_id** (INT) — Идентификатор торговой пары. FOREIGN KEY на trading_pairs(pair_id).
- **recorded_at** (TIMESTAMPTZ) — Время записи данных. PRIMARY KEY (совместно с pair_id).
- **funding_rate** (NUMERIC(12, 8)) — Текущая фандинговая ставка.
- **spot_price** (NUMERIC(20, 8)) — Цена на спотовом рынке.
- **perp_price** (NUMERIC(20, 8)) — Цена на perpetual фьючерсном рынке.
- **next_funding_time** (TIMESTAMPTZ) — Время следующего фандинга.
- **spread_percent** (NUMERIC(10, 4)) — Процент спреда между спотом и фьючерсом. Вычисляемое поле.
- **predicted_apy** (NUMERIC(10, 2)) — Прогнозируемая годовая доходность. Вычисляемое поле.

**Ограничения (Constraints)**:
- **funding_rate_history_pkey** (PRIMARY KEY): Первичный ключ на полях (pair_id, recorded_at).
- **funding_rate_history_pair_id_fkey** (FOREIGN KEY): Внешний ключ, связывающий pair_id с таблицей trading_pairs. ON DELETE CASCADE.
- **NOT NULL**: Обязательные поля: pair_id, recorded_at, funding_rate, spot_price, perp_price, next_funding_time.

**Особенности**:
- Таблица разделена на партиции по диапазонам времени для оптимизации запросов.
- Вычисляемые поля (spread_percent, predicted_apy) хранятся физически для ускорения чтения.

**Индексы (Indexes)**:
- **idx_funding_history_time_brin** (BRIN INDEX): Оптимизирует запросы по временным диапазонам для упорядоченных данных.

---

### Таблица: market_snapshot_latest (Актуальные рыночные данные)
**Назначение**: Кэш последних рыночных данных для быстрого доступа в дашбордах и расчетах.  
**Описание полей**:
- **pair_id** (INT) — Идентификатор торговой пары. PRIMARY KEY и FOREIGN KEY на trading_pairs(pair_id).
- **funding_rate** (NUMERIC(12, 8)) — Текущая фандинговая ставка.
- **spot_price** (NUMERIC(20, 8)) — Текущая цена на спотовом рынке.
- **perp_price** (NUMERIC(20, 8)) — Текущая цена на perpetual фьючерсном рынке.
- **spread_percent** (NUMERIC(10, 4)) — Текущий процент спреда.
- **apy** (NUMERIC(10, 2)) — Текущая годовая доходность.
- **next_funding_time** (TIMESTAMPTZ) — Время следующего фандинга.
- **updated_at** (TIMESTAMPTZ) — Время последнего обновления данных.

**Ограничения (Constraints)**:
- **market_snapshot_latest_pkey** (PRIMARY KEY): Первичный ключ на поле pair_id.
- **market_snapshot_latest_pair_id_fkey** (FOREIGN KEY): Внешний ключ, связывающий pair_id с таблицей trading_pairs. ON DELETE CASCADE.
- **NOT NULL**: Обязательные поля: pair_id, updated_at.

---

### Таблица: positions (Торговые позиции)
**Назначение**: Хранение информации об открытых и закрытых арбитражных позициях пользователей.  
**Описание полей**:
- **position_id** (UUID) — Уникальный идентификатор позиции. PRIMARY KEY. Генерируется автоматически.
- **user_id** (BIGINT) — Идентификатор владельца позиции. FOREIGN KEY на users(user_id).
- **pair_id** (INT) — Идентификатор торговой пары. FOREIGN KEY на trading_pairs(pair_id).
- **is_open** (BOOLEAN) — Флаг открытой позиции.
- **side** (VARCHAR(10)) — Стратегия арбитража. По умолчанию 'LONG_SPOT_SHORT_PERP'.
- **entry_spot_price** (NUMERIC(20, 8)) — Цена входа на спотовом рынке.
- **entry_perp_price** (NUMERIC(20, 8)) — Цена входа на фьючерсном рынке.
- **size_asset** (NUMERIC(20, 8)) — Количество базового актива в позиции.
- **leverage** (INT) — Используемое плечо. По умолчанию 1.
- **exit_spot_price** (NUMERIC(20, 8)) — Цена выхода на спотовом рынке.
- **exit_perp_price** (NUMERIC(20, 8)) — Цена выхода на фьючерсном рынке.
- **realized_pnl_usdt** (NUMERIC(20, 8)) — Реализованная прибыль/убыток в USDT.
- **fees_paid_usdt** (NUMERIC(20, 8)) — Уплаченные комиссии в USDT.
- **accumulated_funding_usdt** (NUMERIC(20, 8)) — Накопленные выплаты по фандингу.
- **opened_at** (TIMESTAMPTZ) — Время открытия позиции.
- **closed_at** (TIMESTAMPTZ) — Время закрытия позиции.

**Ограничения (Constraints)**:
- **positions_pkey** (PRIMARY KEY): Первичный ключ на поле position_id.
- **positions_user_id_fkey** (FOREIGN KEY): Внешний ключ на users(user_id).
- **positions_pair_id_fkey** (FOREIGN KEY): Внешний ключ на trading_pairs(pair_id).
- **NOT NULL**: Обязательные поля: position_id, user_id, pair_id, is_open, side, entry_spot_price, entry_perp_price, size_asset, leverage, opened_at.

**Индексы (Indexes)**:
- **idx_positions_user_active** (PARTIAL INDEX): Ускоряет поиск активных позиций конкретного пользователя (WHERE is_open = TRUE).

---

### Таблица: alerts (Оповещения)
**Назначение**: Хранение настроек пользовательских оповещений о рыночных условиях.  
**Описание полей**:
- **alert_id** (UUID) — Уникальный идентификатор оповещения. PRIMARY KEY. Генерируется автоматически.
- **user_id** (BIGINT) — Идентификатор владельца оповещения. FOREIGN KEY на users(user_id).
- **pair_id** (INT) — Идентификатор торговой пары. Может быть NULL (глобальное оповещение).
- **condition_type** (VARCHAR(50)) — Тип условия. Допустимые значения: 'funding_gt', 'spread_gt', 'apy_gt'.
- **threshold_value** (NUMERIC(20, 8)) — Пороговое значение для срабатывания.
- **notification_channels** (JSONB) — Каналы уведомлений. По умолчанию '["email"]'.
- **is_active** (BOOLEAN) — Флаг активности оповещения.
- **last_triggered_at** (TIMESTAMPTZ) — Время последнего срабатывания.
- **cooldown_minutes** (INT) — Время охлаждения между срабатываниями в минутах. По умолчанию 60.

**Ограничения (Constraints)**:
- **alerts_pkey** (PRIMARY KEY): Первичный ключ на поле alert_id.
- **alerts_user_id_fkey** (FOREIGN KEY): Внешний ключ на users(user_id). ON DELETE CASCADE.
- **alerts_pair_id_fkey** (FOREIGN KEY): Внешний ключ на trading_pairs(pair_id). Может быть NULL.
- **condition_type_check**: Проверка допустимых значений для condition_type.
- **NOT NULL**: Обязательные поля: alert_id, user_id, condition_type, threshold_value, is_active.

---

## 2. Представления (Views)

### Представление: view_dashboard_tickers
**Назначение**: Предоставление актуальных рыночных данных для отображения в дашборде.  
**Источники данных**: trading_pairs, market_snapshot_latest.  
**Поля**:
- pair_id, symbol — Идентификатор и символ торговой пары
- spot_price, perp_price — Текущие цены
- funding_rate, spread_percent, apy — Показатели доходности
- next_funding_time, updated_at — Временные метки

**Особенности**: Автоматически фильтрует только активные торговые пары (is_active = TRUE).

### Представление: view_user_active_portfolio
**Назначение**: Расчет текущей прибыли/убытка по открытым позициям пользователей.  
**Источники данных**: positions, trading_pairs, market_snapshot_latest.  
**Поля**:
- position_id, user_id — Идентификаторы позиции и пользователя
- symbol, size_asset, leverage — Параметры позиции
- entry_spot_price, entry_perp_price — Цены входа
- current_spot, current_perp — Текущие рыночные цены
- pnl_spot_est, pnl_perp_est — Оценочная прибыль по споту и фьючерсу
- accumulated_funding_usdt — Накопленный фандинг

**Особенности**: Рассчитывает текущий PnL в реальном времени, используя актуальные рыночные данные.

## 3. Системные объекты

### Таблица: system_logs (Системные логи)
**Назначение**: Хранение журналов событий и ошибок системы для мониторинга и отладки.  
**Описание полей**:
- **log_id** (BIGSERIAL) — Уникальный идентификатор записи.
- **level** (VARCHAR(10)) — Уровень важности. Допустимые значения: 'INFO', 'WARN', 'ERROR'.
- **source** (VARCHAR(50)) — Источник лога.
- **message** (TEXT) — Текст сообщения.
- **meta** (JSONB) — Дополнительные метаданные.
- **created_at** (TIMESTAMPTZ) — Время создания записи.

**Ограничения (Constraints)**:
- **level_check**: Проверка допустимых значений для поля level.
- **NOT NULL**: Обязательные поля: level, created_at.

**Особенности**:
- Таблица разделена на партиции по диапазонам времени для эффективного хранения и очистки старых данных.

### Функция: fn_update_timestamp
**Назначение**: Автоматическое обновление поля updated_at при изменении записи.  
**Триггеры**:
- **trg_users_update**: Срабатывает на таблице users перед UPDATE.

## 4. Порядок заполнения данных

1. **Справочники**:
   - exchanges (биржи)
   - trading_pairs (торговые пары)

2. **Пользователи и доступ**:
   - users (пользователи)
   - user_api_keys (API-ключи)

3. **Рыночные данные**:
   - market_snapshot_latest (актуальные данные)
   - funding_rate_history (исторические данные)

4. **Торговые операции**:
   - positions (позиции)
   - alerts (оповещения)

5. **Системные данные**:
   - system_logs (логи)

Связующие таблицы заполняются автоматически в процессе работы системы. Представления генерируются динамически на основе актуальных данных из основных таблиц.
