Архитектор базы данных для музыкальной социальной платформы
1. Основные сущности
Таблица: users (Пользователи)

Назначение: Хранение базовой информации о пользователях музыкальной платформы.

Описание полей:

id (CHAR(32)) — Уникальный идентификатор пользователя. PRIMARY KEY.

name (VARCHAR(255)) — Отображаемое имя пользователя в системе.

Ограничения (Constraints):

users_pk (PRIMARY KEY): Первичный ключ на поле id.

NOT NULL: Поля id, name являются обязательными.

Индексы: Первичный ключ автоматически создает уникальный индекс.

Таблица: groups (Группы/Комнаты)

Назначение: Хранение информации о музыкальных группах/комнатах, где пользователи совместно слушают музыку.

Описание полей:

id (CHAR(32)) — Уникальный идентификатор группы. PRIMARY KEY.

name (VARCHAR(1000)) — Название группы/комнаты.

is_public (BOOLEAN) — Флаг доступности группы (публичная/приватная).

Ограничения:

groups_pk (PRIMARY KEY): Первичный ключ на поле id.

groups_name_unique (UNIQUE): Уникальное ограничение на поле name.

NOT NULL: Поля id, name, is_public являются обязательными.

Индексы:

groups_name_unique (UNIQUE INDEX): Гарантирует уникальность названий групп и ускоряет поиск по имени.

Таблица: playlists (Плейлисты)

Назначение: Хранение информации о плейлистах, принадлежащих конкретным группам.

Описание полей:

id (CHAR(32)) — Уникальный идентификатор плейлиста.

group_id (CHAR(32)) — Идентификатор группы, владеющей плейлистом. FOREIGN KEY на groups(id).

current_track_index (INTEGER) — Индекс текущего воспроизводимого трека в плейлисте.

Ограничения:

playlists_pk (PRIMARY KEY): Составной первичный ключ на полях (id, group_id).

playlists_group_id_fkey (FOREIGN KEY): Внешний ключ, связывающий group_id с таблицей groups.

NOT NULL: Поля id, group_id, current_track_index являются обязательными.

Индексы: Составной первичный ключ автоматически создает уникальный индекс.

Таблица: tracks (Треки)

Назначение: Хранение информации о музыкальных треках в плейлистах.

Описание полей:

id (INTEGER) — Уникальный идентификатор трека. PRIMARY KEY с автоинкрементом.

playlist_id (CHAR(32)) — Идентификатор плейлиста, содержащего трек. FOREIGN KEY на playlists(id).

added_by_user_id (CHAR(32)) — Идентификатор пользователя, добавившего трек. FOREIGN KEY на users(id).

service (VARCHAR(12)) — Музыкальный сервис-источник трека (например, "spotify", "youtube").

title (VARCHAR(512)) — Название трека.

duration (INTEGER) — Длительность трека в секундах.

external_url (TEXT) — Внешняя ссылка на трек в оригинальном сервисе.

added_at (DATETIME) — Временная метка добавления трека.

Ограничения:

tracks_pk (PRIMARY KEY): Первичный ключ на поле id.

tracks_playlist_id_fkey (FOREIGN KEY): Внешний ключ на playlists(id).

tracks_added_by_user_id_fkey (FOREIGN KEY): Внешний ключ на users(id).

NOT NULL: Все поля таблицы являются обязательными.

Индексы:

Неявные индексы для внешних ключей. Для ускорения поиска по playlist_id рекомендуется добавить индекс.

2. Связующие таблицы и вспомогательные сущности
Таблица: connections (Подключения пользователей к группам)

Назначение: Реализация связи «многие-ко-многим» между пользователями и группами с указанием роли пользователя в группе.

Описание полей:

id (CHAR(32)) — Уникальный идентификатор подключения.

user_id (CHAR(32)) — Идентификатор пользователя. FOREIGN KEY на users(id).

group_id (CHAR(32)) — Идентификатор группы. FOREIGN KEY на groups(id).

joined_at (DATETIME) — Временная метка подключения пользователя к группе.

role (VARCHAR(10)) — Роль пользователя в группе (например, "admin", "member").

Ограничения:

connections_pk (PRIMARY KEY): Составной первичный ключ на полях (user_id, group_id, id).

connections_user_id_fkey (FOREIGN KEY): Внешний ключ на users(id).

connections_group_id_fkey (FOREIGN KEY): Внешний ключ на groups(id).

NOT NULL: Все поля таблицы являются обязательными.

Индексы: Составной первичный ключ автоматически создает уникальный индекс.

Таблица: user_credentials (Учетные данные пользователей)

Назначение: Хранение аутентификационных токенов пользователей для внешних музыкальных сервисов.

Описание полей:

id (INTEGER) — Уникальный идентификатор записи. PRIMARY KEY с автоинкрементом.

user_id (CHAR(32)) — Идентификатор пользователя. FOREIGN KEY на users(id).

service (VARCHAR(12)) — Музыкальный сервис (например, "spotify", "youtube").

token (TEXT) — Аутентификационный токен для доступа к сервису.

expiry (DATETIME) — Срок действия токена (может быть NULL для бессрочных токенов).

Ограничения:

user_credentials_pk (PRIMARY KEY): Первичный ключ на поле id.

user_credentials_user_id_fkey (FOREIGN KEY): Внешний ключ на users(id).

NOT NULL: Поля id, user_id, service, token являются обязательными.

Индексы:

Для ускорения поиска учетных данных конкретного пользователя рекомендуется добавить индекс по полю user_id.

Для предотвращения дублирования учетных данных одного сервиса для пользователя можно добавить составной уникальный индекс по полям (user_id, service).

Таблица: groupqr (QR-коды групп)

Назначение: Хранение QR-кодов для быстрого подключения к группам с ограниченным сроком действия.

Описание полей:

id (CHAR(32)) — Уникальный идентификатор QR-кода. PRIMARY KEY.

group_id (CHAR(32)) — Идентификатор группы. FOREIGN KEY на groups(id).

url (VARCHAR(1000)) — URL-адрес QR-кода.

expired_at (DATETIME) — Временная метка истечения срока действия QR-кода.

Ограничения:

groupqr_pk (PRIMARY KEY): Первичный ключ на поле id.

groupqr_group_id_fkey (FOREIGN KEY): Внешний ключ на groups(id).

groupqr_group_id_unique (UNIQUE): Уникальное ограничение на поле group_id (один QR-код на группу).

groupqr_url_unique (UNIQUE): Уникальное ограничение на поле url.

NOT NULL: Все поля таблицы являются обязательными.

Индексы:

Уникальные индексы автоматически создаются для полей group_id и url.

3. Системные таблицы
Таблица: alembic_version (Версии миграций)

Назначение: Отслеживание версий схемы базы данных для системы миграций Alembic.

Описание полей:

version_num (VARCHAR(32)) — Номер версии миграции. PRIMARY KEY.

Ограничения:

alembic_version_pkc (PRIMARY KEY): Первичный ключ на поле version_num.

NOT NULL: Поле version_num является обязательным.

Таблица: sqlite_master (Метаданные SQLite)

Назначение: Системная таблица SQLite, содержащая метаинформацию о структуре базы данных.

Описание полей:

type (TEXT) — Тип объекта (таблица, индекс, вид и т.д.).

name (TEXT) — Имя объекта.

tbl_name (TEXT) — Имя таблицы, к которой относится объект.

rootpage (INT) — Номер корневой страницы в файле базы данных.

sql (TEXT) — SQL-запрос, создавший объект (если доступен).

4. Архитектурные особенности
Связи между сущностями:
users ↔ groups (многие-ко-многим): Через таблицу connections

groups → playlists (один-ко-многим): Группа имеет один плейлист

playlists → tracks (один-ко-многим): Плейлист содержит множество треков

users → tracks (один-ко-многим): Пользователь добавляет множество треков

users → user_credentials (один-ко-многим): Пользователь имеет учетные данные для нескольких сервисов

groups → groupqr (один-к-одному): Группа имеет один активный QR-код

Бизнес-логика:
Роли в группах: Разделение на администраторов и обычных участников

Контроль доступа: Публичные и приватные группы

Временные ограничения: QR-коды с ограниченным сроком действия

Мультисервисность: Поддержка различных музыкальных сервисов (Spotify, YouTube и др.)

Коллаборативное прослушивание: Совместное управление плейлистом в реальном времени

Рекомендуемые индексы (дополнительно к существующим):
idx_tracks_playlist_id — для быстрого поиска треков в плейлисте

idx_connections_user_id — для быстрого поиска групп пользователя

idx_connections_group_id — для быстрого поиска участников группы

idx_user_credentials_user_id — для быстрого доступа к учетным данным

idx_groupqr_expired_at — для эффективной очистки просроченных QR-кодов

5. Порядок заполнения таблиц
Пользователи (users) — по мере регистрации в системе

Группы (groups) — создаются пользователями

Подключения (connections) — по мере вступления пользователей в группы

Плейлисты (playlists) — автоматически создаются для новых групп

Треки (tracks) — добавляются участниками групп в плейлисты

Учетные данные (user_credentials) — добавляются при подключении музыкальных сервисов

QR-коды (groupqr) — генерируются по необходимости для приглашения в группы

Примечание: Таблицы alembic_version и sqlite_master управляются автоматически системами миграций и СУБД соответственно.